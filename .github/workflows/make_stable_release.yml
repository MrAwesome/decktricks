name: Make Stable Release

# TODO: take/create release notes (maybe just do that on the latest tag)
on: workflow_dispatch

jobs:
  update_stable_branch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Update stable branch
        run: |
          ./scripts/update_stable_branch.sh

  make_stable_release:
    runs-on: ubuntu-latest
    needs:
      - update_stable_branch
    steps:
      - run: mkdir /tmp/artifacts

      - name: Download artifacts
        run: |
          curl -S -s -L -O --output-dir /tmp/artifacts --connect-timeout 60 https://github.com/MrAwesome/decktricks/releases/download/latest/decktricks_install.desktop
          curl -S -s -L -O --output-dir /tmp/artifacts --connect-timeout 60 https://github.com/MrAwesome/decktricks/releases/download/latest/decktricks_install.sh
          curl -S -s -L -O --output-dir /tmp/artifacts --connect-timeout 60 https://github.com/MrAwesome/decktricks/releases/download/latest/decktricks.tar.xz

      - name: Update stable release
        uses: softprops/action-gh-release@v2
        #if: startsWith(github.ref, 'refs/tags/')
        with:
          fail_on_unmatched_files: true
          prerelease: false
          make_latest: true
          name: Decktricks Stable
          tag_name: stable
          files: |
            /tmp/artifacts/decktricks.tar.xz
            /tmp/artifacts/decktricks_install.desktop
            /tmp/artifacts/decktricks_install.sh
