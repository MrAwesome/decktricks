name: GUI Debug Build/Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  gui_tests:

    runs-on: ubuntu-latest
    container:
      image: gleesus/decktricks

    steps:
      - name: Preserve $HOME set in the container
        run: echo HOME=/root >> "$GITHUB_ENV"

      - uses: actions/checkout@v4

      - name: Run GUI build script
        run: ./scripts/build_decktricks_gui.sh release

      - name: Get binary from tar
        run: |
          mkdir /tmp/decktricks_work
          tar xvf ./build/decktricks.tar.gz -C /tmp/decktricks_work

      - name: Run GUI e2e scripts
        run: ./scripts/run_all_gui_e2e_tests.sh /tmp/decktricks_work/decktricks-gui

  # TODO: ensure this is enough gating to prevent branch/main PRs from triggering latest tags
  update_latest_branch:
    if: github.event_name == 'push'
    needs: gui_tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update latest branch
        run: |
          ./scripts/update_latest_branch.sh
